<svg width="900" height="500" xmlns="http://www.w3.org/2000/svg">
  <rect width="100%" height="100%" fill="#ffffff" />
  <style>
    .actor-rect { fill: #e1f5fe; stroke: #01579b; stroke-width: 2; }
    .actor-text { font-family: sans-serif; font-size: 14px; font-weight: bold; fill: #333; text-anchor: middle; }
    .line { stroke: #666; stroke-width: 1; stroke-dasharray: 5,5; }
    .arrow { stroke: #333; stroke-width: 1.5; fill: none; marker-end: url(#arrowhead); }
    .msg-text { font-family: sans-serif; font-size: 12px; fill: #000; }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
  </defs>

  <!-- Actors -->
  <g transform="translate(50, 20)">
    <rect width="120" height="40" rx="5" class="actor-rect" />
    <text x="60" y="25" class="actor-text">Caller</text>
    <line x1="60" y1="40" x2="60" y2="450" class="line" />
  </g>
  <g transform="translate(220, 20)">
    <rect width="140" height="40" rx="5" class="actor-rect" style="fill: #e8f5e9; stroke: #2e7d32;" />
    <text x="70" y="25" class="actor-text">SearchService</text>
    <line x1="70" y1="40" x2="70" y2="450" class="line" />
  </g>
  <g transform="translate(410, 20)">
    <rect width="140" height="40" rx="5" class="actor-rect" />
    <text x="70" y="25" class="actor-text">HybridPipeline</text>
    <line x1="70" y1="40" x2="70" y2="450" class="line" />
  </g>
  <g transform="translate(580, 20)">
    <rect width="120" height="40" rx="5" class="actor-rect" />
    <text x="60" y="25" class="actor-text">FTS5Repo</text>
    <line x1="60" y1="40" x2="60" y2="450" class="line" />
  </g>
  <g transform="translate(750, 20)">
    <rect width="120" height="40" rx="5" class="actor-rect" />
    <text x="60" y="25" class="actor-text">EmbeddingRepo</text>
    <line x1="60" y1="40" x2="60" y2="450" class="line" />
  </g>

  <!-- Sequence -->
  <!-- 1. hybrid_search -->
  <path d="M110,80 L280,80" class="arrow" />
  <text x="120" y="75" class="msg-text">hybrid_search(query)</text>

  <!-- 2. init pipeline -->
  <path d="M290,110 L470,110" class="arrow" />
  <text x="300" y="105" class="msg-text">search(query)</text>

  <!-- 3. FTS search -->
  <path d="M480,140 L630,140" class="arrow" />
  <text x="490" y="135" class="msg-text">search(query)</text>
  <path d="M630,170 L480,170" class="arrow" style="stroke-dasharray: 3,3;" />
  <text x="490" y="165" class="msg-text">List[SearchResult]</text>

  <!-- 4. Vector search -->
  <path d="M480,210 L800,210" class="arrow" />
  <text x="490" y="205" class="msg-text">search_vectors(embedding)</text>
  <path d="M800,240 L480,240" class="arrow" style="stroke-dasharray: 3,3;" />
  <text x="490" y="235" class="msg-text">List[SearchResult]</text>

  <!-- 5. RRF Fusion -->
  <rect x="430" y="270" width="100" height="30" rx="5" fill="#fff9c4" stroke="#fbc02d" />
  <text x="480" y="290" class="msg-text" style="text-anchor: middle; font-size: 10px;">RRF Fusion</text>

  <!-- 6. Optional Rerank -->
  <path d="M480,330 L480,360 L520,360 L520,330" class="arrow" />
  <text x="530" y="350" class="msg-text">rerank(candidates)</text>

  <!-- 7. Return Result -->
  <path d="M470,400 L290,400" class="arrow" style="stroke-dasharray: 3,3;" />
  <text x="300" y="395" class="msg-text">List[RankedResult]</text>
  <path d="M280,430 L110,430" class="arrow" style="stroke-dasharray: 3,3;" />
  <text x="120" y="425" class="msg-text">List[RankedResult]</text>

</svg>
